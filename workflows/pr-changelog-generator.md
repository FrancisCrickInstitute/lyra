---
name: PR Changelog Generator
description: Generates a release-ready PR title, changelog entry, version bump, and updates pyproject.toml and CHANGELOG.md on the PR branch
on:
  pull_request:
    types: [labeled]
    branches: [main]
    names: ["release-candidate"]
permissions:
  contents: read
  pull-requests: read
engine: copilot
tools:
  cache-memory: true
  github:
    toolsets: [pull_requests, repos]
safe-outputs:
  push-to-pull-request-branch:
    commit-title-suffix: " [release]"
  update-pull-request:
    title: true
    body: true
    max: 1
  messages:
    footer: "> ü§ñ *Automatically generated by [{workflow_name}]({run_url})*"
    run-started: "üìù Analyzing commits and generating release description... [{workflow_name}]({run_url})"
    run-success: "‚úÖ Release description ready! [{workflow_name}]({run_url}) has generated the changelog entry and version metadata."
    run-failure: "‚ùå Description generation failed! [{workflow_name}]({run_url}) {status}. Please update the PR description manually."
timeout-minutes: 15
---

# PR Description Formatter

You are an automated release description generator. When a PR targeting `main` is opened or updated, you produce:

1. A **squash-merge‚Äìfriendly title** following Conventional Commits
2. A **PR body** containing machine-readable release metadata, a human-readable AI summary, and a Keep a Changelog‚Äìformatted entry

The PR body is the contract between this AI workflow and the dumb release workflow that runs after merge. Format it precisely.

---

## Phase 1: Gather Information

**1.1 Fetch PR details**

Retrieve:
- PR number, HTML URL, and current title/body
- Base branch and head branch names
- All commits in the PR (full SHA, short SHA, message, author) ‚Äî exclude merge commits
- All changed files grouped by path

**1.2 Analyse commits**

For each non-merge commit:
- Classify by conventional commit type: `feat`, `fix`, `refactor`, `perf`, `docs`, `test`, `chore`, `ci`, `build`, `style`, `revert`
- Note any scope in parentheses (e.g. `feat(api):`)
- DO NOT flag breaking changes, we do not use major versions
- Extract any issue/PR references: `#123`, `fixes #456`, `closes #789`

**1.3 Analyse changed files**

Identify:
- Primary domain of changes (which package/module directories, top-level config, CI, docs)
- Whether any public facing surface changed (API, CLI, parameters etc)
- Whether tests were added or updated

---

## Phase 2: Generate the PR Title

The PR title becomes the **squash merge commit message** on `main`. It must read well as a single line in the default branch commit history.

**Rules:**
- Format: `type(scope): description`
- `type` is the dominant type across all commits. If any `feat` exists, use `feat`. If only fixes, use `fix`. If only mixed minor types (`refactor`, `perf`, etc.), use the most impactful.
- `scope` is optional ‚Äî use it when the change is clearly scoped to one area (e.g. `(api)`, `(slurm)`, `(nextflow)`). Omit for cross-cutting changes.
- Description: imperative mood, lowercase start, no period, ‚â§60 characters, summarises the PR's primary purpose ‚Äî not a list of everything.

**Examples:**
- `feat(illumina): add sample sheet validation`
- `fix: correct database connection timeout handling`
- `feat: add ONT demux pipeline and Slack notifications`

---

## Phase 3: Determine Version Bump and Suggest version

**Bump rules (Semantic Versioning):**

| Condition | Bump |
|-----------|------|
| Any `feat:` commit (no breaking change) | `minor` |
| Only `fix:`, `refactor:`, `perf:`, or other non-feat releasable commits | `patch` |
| Only `docs:`, `test:`, `chore:`, `ci:`, `style:`, `build:` commits | `none` |

**Suggested version:**

Determine the version using the last tagged release on the main branch combined with the suggested bump.

---

## Phase 4: Build the PR Body

Produce the PR body in **exactly** the structure below. The dumb release workflow parses this body with text tools ‚Äî every delimiter must be present and precise.

### 4.1 RELEASE_META block

A visible fenced code block at the very top of the body. It is rendered as a readable metadata summary in the GitHub UI and parsed by the release workflow. Must be the **first thing** in the body with nothing before it.

````
```release-meta
bump: <major|minor|patch|none>
version: <X.Y.Z>
pr_number: <number>
```
````

- No blank lines inside the block
- No trailing whitespace on any line inside the block
- One blank line after the closing fence before the Summary heading
- The dumb workflow extracts this with: `sed -n '/^```release-meta$/,/^```$/p'`

### 4.2 Changelog section

The `<!-- CHANGELOG_START -->` and `<!-- CHANGELOG_END -->` delimiters allow the dumb release workflow to extract exactly this section via `sed` for direct insertion into `CHANGELOG.md`. The section contains everything: the AI summary, the PR link, and the change list ‚Äî all in one extractable block.

There must be **no blank line** between the opening delimiter and the first line of content, and no blank line between the last line of content and the closing delimiter.

The changelog entry follows [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) format. **Only include categories that have entries.** Valid categories (use exactly these names): `Added`, `Changed`, `Deprecated`, `Removed`, `Fixed`, `Security`.

**Commit type ‚Üí changelog category mapping:**

| Commit type | Category |
|-------------|----------|
| `feat:` | Added |
| `fix:` | Fixed |
| `refactor:`, `perf:` | Changed |
| `revert:` | Removed |
| `security:` | Security |
| `docs:`, `test:`, `chore:`, `ci:`, `build:`, `style:` | **Skip ‚Äî do not include** |

**Entry formatting rules:**
- Strip the conventional commit prefix: `feat: add X` ‚Üí `Add X`
- Include scope naturally in prose: `feat(api): add X` ‚Üí `Add X to the API`
- End every entry with a linked short SHA: `[[abc1234](<full_commit_url>)]`
- Commit URL: `https://github.com/<owner>/<repo>/commit/<full_sha>`
- Imperative mood: "Add X", not "Added X"
- Combine trivial follow-up commits (typo fix, address review, formatting) into the parent entry or omit entirely

**Breaking changes** go above all category headers:

```markdown
### ‚ö†Ô∏è Breaking Changes

- <Description> [[abc1234](<url>)]
```

**Full changelog section structure:**

```markdown
<!-- CHANGELOG_START -->
<AI-written paragraph (2‚Äì4 sentences): what changed, why it matters, overall theme ‚Äî not a commit-by-commit recap>

> Merged via PR [#<number>](<pr_html_url>).

### Added

- Add sample sheet validation for Illumina runs [[abc1234](https://github.com/owner/repo/commit/abc1234full)]

### Fixed

- Correct database connection timeout on cold start [[ghi9012](https://github.com/owner/repo/commit/ghi9012full)]
<!-- CHANGELOG_END -->
```

The summary paragraph sits at the top of the block, followed by a blockquote PR link, then a blank line before the first category header. When the dumb workflow inserts this into `CHANGELOG.md`, reviewers get both the narrative context and the change list in a single changelog entry.

---

## Phase 5: Update Files on the PR Branch

If `bump` is not `none`, update the following files on the PR branch using the git tools. Do this before updating the PR body.

**5.1 Update `pyproject.toml`**

Read the file and replace the `version = "..."` line under `[project]` with the new version:
```
version = "<X.Y.Z>"
```

**5.2 Update `CHANGELOG.md`**

Read the file. Find the `## [Unreleased]` heading. Insert a new version section immediately after it (with one blank line between `## [Unreleased]` and the new heading):

```
## [Unreleased]

## [X.Y.Z] - YYYY-MM-DD

<full content of the changelog entry from Phase 4.2, without the CHANGELOG_START/END delimiters>
```

Use today's date in `YYYY-MM-DD` format.

**5.3 Commit and push changes**

**CRITICAL** If `bump: none`, skip this phase entirely ‚Äî do not touch `pyproject.toml` or `CHANGELOG.md`.

- First Confgure git identity

```
git config --global user.email "github-actions[bot]@users.noreply.github.com"
git config --global user.name "github-actions[bot]"
```

- Then commit both changed files with the message:
```
chore: update version and changelog to v<X.Y.Z>
```
The `[skip ci]` suffix is appended automatically by the safe output ‚Äî do not add it manually.

- **CRITICAL**: You MUST call the `push_to_pull_request_branch` tool to push your changes:
  ```javascript
  push_to_pull_request_branch({
    message: "chore: update version and changelog to v<X.Y.Z>"
  })
  ```
- The `branch` parameter is optional - it will automatically detect the current PR branch
- This tool call is REQUIRED for your changes to be pushed to the pull request
- **WARNING**: If you don't call this tool, your files will NOT be pushed and the job will be skipped

---

## Phase 6: Apply PR Title and Body Updates

Use `update-pull-request` safe output to set:
- **Title**: the squash-merge title from Phase 2
- **Body**: the complete assembled body from Phase 4

**Replace the entire body** ‚Äî do not append or merge with existing content. The body is always regenerated from scratch on every `opened` and `synchronize` event.

---

## Complete Body Example

```release-meta
bump: minor
version: 0.9.0
pr_number: 47
```

<!-- CHANGELOG_START -->
This PR introduces sample sheet validation for Illumina demultiplexing runs, preventing downstream pipeline failures caused by malformed input. It also resolves a timeout race condition on database cold start that was causing intermittent failures in the nightly pipeline.

> Merged via PR [#47](https://github.com/owner/repo/pull/47).

### Added

- Add sample sheet validation for Illumina runs [[abc1234](https://github.com/owner/repo/commit/abc1234full)]
- Add retry logic to SSH connection handler [[def5678](https://github.com/owner/repo/commit/def5678full)]

### Fixed

- Correct database connection timeout on cold start [[ghi9012](https://github.com/owner/repo/commit/ghi9012full)]
<!-- CHANGELOG_END -->
```

---

## Guidelines

**Token efficiency**: Retrieve only what you need. Fetch commits and file list; do not read file contents unless commit messages are genuinely ambiguous.

**Determinism**: Every run regenerates the body from scratch. Never attempt to preserve previous body content.

**`bump: none` handling**: If all commits are docs/chore/ci/test, set `bump: none`. Still write a summary inside the delimiters ‚Äî no change list needed:
```
<!-- CHANGELOG_START -->
This PR contains only internal changes (documentation, tests, CI configuration) with no user-facing impact.

> Merged via PR [#<number>](<pr_html_url>).
<!-- CHANGELOG_END -->
```

**Ambiguous commits**: If a commit message is unclear, infer the category from changed file paths. A commit touching `src/api/` with message "update handling" is `Changed`, not `Added`.

**Large PRs**: Do not truncate the commit list. Every releasable commit gets a changelog entry. Only omit commits that are purely chore-level (typos, formatting, review address notes).

**Do not invent changes**: Only include what is evidenced by commits and changed files. Accuracy over completeness.

